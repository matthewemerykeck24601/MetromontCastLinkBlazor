@page "/signin-acc"
@using System.Web
@using MetromontCastLink.Shared.Services
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Spinner
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject IACCService ACCService
@inject HttpClient HttpClient

<PageTitle>Sign in to Autodesk Construction Cloud</PageTitle>

<div class="signin-page">
    <div class="signin-container">
        <div class="signin-content">
            <div class="signin-header">
                <img src="/images/metromont-logo.png" alt="Metromont" class="company-logo" />
                <h2>Connect to Autodesk Construction Cloud</h2>
                <p>Sign in to access your ACC projects and data</p>
            </div>

            @if (IsLoading)
            {
                <div class="signin-loading">
                    <SfSpinner Size="40" Label="Connecting to ACC..." />
                </div>
            }
            else if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div class="signin-error">
                    <div class="error-icon">⚠️</div>
                    <h3>Connection Error</h3>
                    <p>@ErrorMessage</p>
                    <SfButton CssClass="e-primary" @onclick="RetrySignIn">Try Again</SfButton>
                </div>
            }
            else
            {
                <div class="signin-actions">
                    <SfButton CssClass="e-primary e-large" IconCss="e-icons e-login"
                              @onclick="SignInToACC">
                        Sign in with Autodesk ID
                    </SfButton>
                    <p class="signin-note">
                        You'll be redirected to Autodesk's secure sign-in page
                    </p>

                    <!-- Debug info -->
                    <div style="margin-top: 2rem; padding: 1rem; background: #f3f4f6; border-radius: 0.5rem; text-align: left; font-size: 0.875rem;">
                        <p><strong>Debug Info:</strong></p>
                        <p>Page loaded: @DateTime.Now.ToString("HH:mm:ss")</p>
                        <p>Button clicks: @ButtonClickCount</p>
                        <button @onclick="TestButtonClick" style="padding: 0.5rem 1rem; margin-top: 0.5rem;">Test Basic Button</button>
                        <button @onclick="CheckSessionStorage" style="padding: 0.5rem 1rem; margin-top: 0.5rem; margin-left: 0.5rem;">Check Session Storage</button>
                        @if (!string.IsNullOrEmpty(DebugInfo))
                        {
                            <pre style="margin-top: 1rem; padding: 0.5rem; background: white; border-radius: 0.25rem; overflow-x: auto;">@DebugInfo</pre>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .signin-page {
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
    }

    .signin-container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        max-width: 480px;
        width: 100%;
    }

    .signin-content {
        padding: 3rem 2rem;
        text-align: center;
    }

    .signin-header {
        margin-bottom: 2rem;
    }

    .company-logo {
        height: 60px;
        margin-bottom: 1rem;
    }

    .signin-header h2 {
        color: #1e293b;
        font-size: 1.75rem;
        font-weight: 600;
        margin: 0 0 0.5rem 0;
    }

    .signin-header p {
        color: #64748b;
        font-size: 1rem;
        margin: 0;
    }

    .signin-loading {
        padding: 2rem 0;
    }

    .signin-error {
        text-align: center;
        padding: 1rem;
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .error-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .signin-error h3 {
        color: #dc2626;
        font-size: 1.125rem;
        font-weight: 600;
        margin: 0 0 0.5rem 0;
    }

    .signin-error p {
        color: #7f1d1d;
        margin: 0 0 1rem 0;
    }

    .signin-actions {
        margin-top: 1rem;
    }

    .signin-note {
        color: #64748b;
        font-size: 0.875rem;
        margin-top: 1rem;
        margin-bottom: 0;
    }

    .e-btn.e-large {
        padding: 12px 24px;
        font-size: 1rem;
        min-width: 200px;
    }
</style>

@code {
    private bool IsLoading;
    private string? ErrorMessage;
    private int ButtonClickCount = 0;
    private string? DebugInfo;

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("SigninACC - OnInitializedAsync called");

        // Check if already authenticated
        var isAuthenticated = await ACCService.IsAuthenticatedAsync();
        Console.WriteLine($"SigninACC - IsAuthenticated: {isAuthenticated}");

        if (isAuthenticated)
        {
            Navigation.NavigateTo("/");
            return;
        }

        // Check for callback parameters
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = HttpUtility.ParseQueryString(uri.Query);

        if (query["code"] != null)
        {
            Console.WriteLine("SigninACC - Authorization code found in URL");
            await HandleAuthCallback(query["code"]!);
        }
        else if (query["error"] != null)
        {
            ErrorMessage = $"Authentication failed: {query["error_description"] ?? query["error"]}";
            Console.WriteLine($"SigninACC - Error in URL: {ErrorMessage}");
        }
    }

    private void TestButtonClick()
    {
        ButtonClickCount++;
        Console.WriteLine($"Test button clicked {ButtonClickCount} times");
        StateHasChanged();
    }

    private async Task CheckSessionStorage()
    {
        try
        {
            var storedData = await JSRuntime.InvokeAsync<string?>("sessionStorage.getItem", "acc_token");
            if (!string.IsNullOrEmpty(storedData))
            {
                DebugInfo = $"Session Storage Data Found:\nLength: {storedData.Length} chars\nFirst 100 chars: {storedData.Substring(0, Math.Min(100, storedData.Length))}...";
            }
            else
            {
                DebugInfo = "No token found in session storage";
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            DebugInfo = $"Error checking session storage: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task SignInToACC()
    {
        try
        {
            ButtonClickCount++;
            Console.WriteLine($"SigninACC - SignInToACC button clicked (count: {ButtonClickCount})");
            IsLoading = true;
            ErrorMessage = null;
            StateHasChanged();

            // First test if the API is reachable
            try
            {
                var testResponse = await HttpClient.GetAsync("/api/auth/test");

                if (testResponse.IsSuccessStatusCode)
                {
                    var testData = await testResponse.Content.ReadAsStringAsync();
                    Console.WriteLine($"SigninACC - API test response: {testData}");
                }
                else
                {
                    Console.WriteLine($"SigninACC - API test failed: {testResponse.StatusCode}");
                }
            }
            catch (Exception testEx)
            {
                Console.WriteLine($"SigninACC - API test error: {testEx.Message}");
            }

            Console.WriteLine("SigninACC - Calling InitiateAuthenticationAsync");
            await ACCService.InitiateAuthenticationAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"SigninACC - Error in SignInToACC: {ex.Message}");
            Console.WriteLine($"SigninACC - Stack trace: {ex.StackTrace}");
            ErrorMessage = $"Failed to initiate sign-in: {ex.Message}";
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleAuthCallback(string code)
    {
        try
        {
            Console.WriteLine($"SigninACC - HandleAuthCallback called with code: {code[..10]}...");
            IsLoading = true;
            StateHasChanged();

            // Call the HandleCallbackAsync method in ACCService
            if (ACCService is MetromontCastLink.Client.Services.ACCService clientService)
            {
                Console.WriteLine("SigninACC - Calling clientService.HandleCallbackAsync");

                try
                {
                    await clientService.HandleCallbackAsync(code);
                    Console.WriteLine("SigninACC - HandleCallbackAsync completed without exception");
                }
                catch (Exception callbackEx)
                {
                    Console.WriteLine($"SigninACC - HandleCallbackAsync threw exception: {callbackEx.Message}");
                    Console.WriteLine($"SigninACC - Exception type: {callbackEx.GetType().Name}");
                    Console.WriteLine($"SigninACC - Stack trace: {callbackEx.StackTrace}");
                    throw;
                }

                // Add a small delay to ensure token is stored
                await Task.Delay(100);

                // Verify authentication was successful
                var isAuthenticated = await ACCService.IsAuthenticatedAsync();
                Console.WriteLine($"SigninACC - After callback, IsAuthenticated: {isAuthenticated}");

                // Debug: Check if tokens are set
                var accessToken = await ACCService.GetAccessTokenAsync();
                Console.WriteLine($"SigninACC - Access token retrieved: {!string.IsNullOrEmpty(accessToken)}");
                if (!string.IsNullOrEmpty(accessToken))
                {
                    Console.WriteLine($"SigninACC - Access token length: {accessToken.Length}");
                }

                // Try to check session storage directly
                try
                {
                    var storedData = await JSRuntime.InvokeAsync<string?>("sessionStorage.getItem", "acc_token");
                    Console.WriteLine($"SigninACC - Session storage has token data: {!string.IsNullOrEmpty(storedData)}");
                    if (!string.IsNullOrEmpty(storedData))
                    {
                        Console.WriteLine($"SigninACC - Session storage data length: {storedData.Length}");

                        // Try to parse and check contents
                        try
                        {
                            var tokenObj = System.Text.Json.JsonSerializer.Deserialize<System.Text.Json.JsonElement>(storedData);
                            Console.WriteLine($"SigninACC - Token has AccessToken: {tokenObj.TryGetProperty("AccessToken", out var at)}");
                            Console.WriteLine($"SigninACC - Token has JwtToken: {tokenObj.TryGetProperty("JwtToken", out var jt)}");
                            Console.WriteLine($"SigninACC - Token has ExpiresAt: {tokenObj.TryGetProperty("ExpiresAt", out var ea)}");
                            if (ea.ValueKind != System.Text.Json.JsonValueKind.Undefined)
                            {
                                Console.WriteLine($"SigninACC - ExpiresAt value: {ea.GetString()}");
                            }
                        }
                        catch (Exception parseEx)
                        {
                            Console.WriteLine($"SigninACC - Error parsing stored token: {parseEx.Message}");
                        }
                    }
                }
                catch (Exception storageEx)
                {
                    Console.WriteLine($"SigninACC - Error checking session storage: {storageEx.Message}");
                }

                if (isAuthenticated)
                {
                    Console.WriteLine("SigninACC - Authentication successful, navigating to home");
                    // Navigate to the main page or dashboard
                    Navigation.NavigateTo("/", forceLoad: true);
                }
                else
                {
                    Console.WriteLine("SigninACC - Authentication failed, isAuthenticated is false");

                    // Additional debug: Try to understand why it's false
                    Console.WriteLine("SigninACC - Checking authentication state details...");

                    // Check if token expired
                    try
                    {
                        var storedData = await JSRuntime.InvokeAsync<string?>("sessionStorage.getItem", "acc_token");
                        if (!string.IsNullOrEmpty(storedData))
                        {
                            var tokenObj = System.Text.Json.JsonSerializer.Deserialize<System.Text.Json.JsonElement>(storedData);
                            if (tokenObj.TryGetProperty("ExpiresAt", out var expiresAt))
                            {
                                var expiryTime = DateTime.Parse(expiresAt.GetString()!);
                                var now = DateTime.UtcNow;
                                Console.WriteLine($"SigninACC - Token expires at: {expiryTime}");
                                Console.WriteLine($"SigninACC - Current time (UTC): {now}");
                                Console.WriteLine($"SigninACC - Token expired: {expiryTime <= now}");
                            }
                        }
                    }
                    catch (Exception debugEx)
                    {
                        Console.WriteLine($"SigninACC - Debug check error: {debugEx.Message}");
                    }

                    ErrorMessage = "Authentication callback failed. Please try again.";
                }
            }
            else
            {
                Console.WriteLine("SigninACC - ACCService is not the expected type");
                ErrorMessage = "Service configuration error. Please contact support.";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"SigninACC - Error in HandleAuthCallback: {ex.Message}");
            Console.WriteLine($"SigninACC - Stack trace: {ex.StackTrace}");
            ErrorMessage = $"Authentication failed: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task RetrySignIn()
    {
        ErrorMessage = null;
        DebugInfo = null;
        await SignInToACC();
    }
}