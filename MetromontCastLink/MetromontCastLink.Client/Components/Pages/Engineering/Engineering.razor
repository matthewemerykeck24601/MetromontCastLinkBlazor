@page "/engineering"
@page "/engineering/index"
@using MetromontCastLink.Shared.Models
@inject NavigationManager Navigation
@inject IACCService ACCService

<PageTitle>Engineering - Metromont CastLink</PageTitle>

<div class="engineering-page">
    <div class="page-header">
        <div class="header-content">
            <div class="header-left">
                <div class="page-icon">
                    <span class="e-icons e-engineering"></span>
                </div>
                <div>
                    <h1>Engineering Center</h1>
                    <p>Design tools, calculators, and technical documentation for precast concrete engineering.</p>
                </div>
            </div>
            <div class="header-right">
                <ACCProjectSelector @bind-SelectedProjectId="@CurrentProjectId" 
                    ShowProjectInfo="false" 
                    Label="Current Project" />
            </div>
        </div>
    </div>

    <div class="tools-dashboard">
        <!-- Row 1: Design Tools -->
        <div class="tools-section">
            <h2 class="section-title">Design Tools</h2>
            <div class="tools-grid">
                <div class="tool-card active" @onclick="() => NavigateToTool('/engineering/calculator')">
                    <div class="tool-header">
                        <div class="tool-icon calculator">
                            <span>🧮</span>
                        </div>
                        <SfChip>
                            <ChipItems>
                                <ChipItem Text="Active" CssClass="status-active" />
                            </ChipItems>
                        </SfChip>
                    </div>
                    <h3>Design Calculator</h3>
                    <p>Engineering calculations for precast concrete elements with PCI code compliance.</p>
                    <div class="tool-features">
                        <span class="feature-tag">Beam Design</span>
                        <span class="feature-tag">Column Design</span>
                        <span class="feature-tag">Connection Design</span>
                    </div>
                    <div class="tool-footer">
                        <span class="tool-type">Interactive Calculator</span>
                        <span class="e-icons e-arrow-right"></span>
                    </div>
                </div>

                <div class="tool-card active" @onclick="() => NavigateToTool('/engineering/viewer')">
                    <div class="tool-header">
                        <div class="tool-icon viewer">
                            <span>🏗️</span>
                        </div>
                        <SfChip>
                            <ChipItems>
                                <ChipItem Text="Active" CssClass="status-active" />
                            </ChipItems>
                        </SfChip>
                    </div>
                    <h3>3D Model Viewer</h3>
                    <p>View and analyze Revit models directly from ACC with measurement and markup tools.</p>
                    <div class="tool-features">
                        <span class="feature-tag">Forge Viewer</span>
                        <span class="feature-tag">ACC Integration</span>
                        <span class="feature-tag">Markups</span>
                    </div>
                    <div class="tool-footer">
                        <span class="tool-type">3D Visualization</span>
                        <span class="e-icons e-arrow-right"></span>
                    </div>
                </div>

                <div class="tool-card coming-soon">
                    <div class="tool-header">
                        <div class="tool-icon summary">
                            <span>📊</span>
                        </div>
                        <SfChip>
                            <ChipItems>
                                <ChipItem Text="Coming Soon" CssClass="status-development" />
                            </ChipItems>
                        </SfChip>
                    </div>
                    <h3>Design Summary Generator</h3>
                    <p>Automated design documentation from calculation results and project data.</p>
                    <div class="tool-features">
                        <span class="feature-tag">Auto-Generate</span>
                        <span class="feature-tag">PDF Export</span>
                        <span class="feature-tag">OSS Integration</span>
                    </div>
                    <div class="tool-footer">
                        <span class="tool-type">Q2 2025</span>
                        <span class="e-icons e-lock"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 2: Documentation Tools -->
        <div class="tools-section">
            <h2 class="section-title">Documentation Tools</h2>
            <div class="tools-grid">
                <div class="tool-card coming-soon">
                    <div class="tool-header">
                        <div class="tool-icon tickets">
                            <span>🎫</span>
                        </div>
                        <SfChip>
                            <ChipItems>
                                <ChipItem Text="Coming Soon" CssClass="status-development" />
                            </ChipItems>
                        </SfChip>
                    </div>
                    <h3>Piece Issue Tickets</h3>
                    <p>Track and manage engineering issues for individual precast pieces.</p>
                    <div class="tool-features">
                        <span class="feature-tag">Issue Tracking</span>
                        <span class="feature-tag">ACC Sync</span>
                        <span class="feature-tag">Notifications</span>
                    </div>
                    <div class="tool-footer">
                        <span class="tool-type">Q3 2025</span>
                        <span class="e-icons e-lock"></span>
                    </div>
                </div>

                <div class="tool-card coming-soon">
                    <div class="tool-header">
                        <div class="tool-icon drawings">
                            <span>📐</span>
                        </div>
                        <SfChip>
                            <ChipItems>
                                <ChipItem Text="Coming Soon" CssClass="status-development" />
                            </ChipItems>
                        </SfChip>
                    </div>
                    <h3>Drawing Management</h3>
                    <p>Organize and version control for shop drawings and engineering details.</p>
                    <div class="tool-features">
                        <span class="feature-tag">Version Control</span>
                        <span class="feature-tag">Approval Workflow</span>
                        <span class="feature-tag">CAD Integration</span>
                    </div>
                    <div class="tool-footer">
                        <span class="tool-type">Q3 2025</span>
                        <span class="e-icons e-lock"></span>
                    </div>
                </div>

                <div class="tool-card coming-soon">
                    <div class="tool-header">
                        <div class="tool-icon specs">
                            <span>📋</span>
                        </div>
                        <SfChip>
                            <ChipItems>
                                <ChipItem Text="Coming Soon" CssClass="status-development" />
                            </ChipItems>
                        </SfChip>
                    </div>
                    <h3>Specification Manager</h3>
                    <p>Manage project specifications and technical requirements.</p>
                    <div class="tool-features">
                        <span class="feature-tag">PCI Standards</span>
                        <span class="feature-tag">Custom Specs</span>
                        <span class="feature-tag">Templates</span>
                    </div>
                    <div class="tool-footer">
                        <span class="tool-type">Q4 2025</span>
                        <span class="e-icons e-lock"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity Section -->
        <div class="activity-section">
            <h2 class="section-title">Recent Engineering Activity</h2>
            <div class="activity-list">
                @if (RecentActivities.Any())
                {
                    @foreach (var activity in RecentActivities)
                    {
                        <div class="activity-item">
                            <div class="activity-icon">
                                <span class="@GetActivityIcon(activity.Type)"></span>
                            </div>
                            <div class="activity-content">
                                <p class="activity-description">@activity.Description</p>
                                <span class="activity-time">@GetRelativeTime(activity.Timestamp)</span>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="no-activity">
                        <p>No recent activity</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<style>
    .engineering-page {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1rem;
    }

    .page-header {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.06);
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 2rem;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }

    .page-icon {
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 28px;
    }

    .header-left h1 {
        margin: 0;
        font-size: 2rem;
        font-weight: 700;
        color: #1e293b;
    }

    .header-left p {
        margin: 0.25rem 0 0 0;
        color: #64748b;
        font-size: 1rem;
    }

    .tools-dashboard {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    .tools-section {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.06);
    }

    .section-title {
        margin: 0 0 1.5rem 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: #1e293b;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #e5e7eb;
    }

    .tools-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1.5rem;
    }

    .tool-card {
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .tool-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }

    .tool-card.active {
        border-color: #6366f1;
        background: #f5f3ff;
    }

    .tool-card.active:hover {
        border-color: #4f46e5;
    }

    .tool-card.coming-soon {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .tool-card.coming-soon:hover {
        transform: none;
        box-shadow: none;
    }

    .tool-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }

    .tool-icon {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .tool-icon.calculator {
        background: #dbeafe;
    }

    .tool-icon.viewer {
        background: #d1fae5;
    }

    .tool-icon.summary {
        background: #fef3c7;
    }

    .tool-icon.tickets {
        background: #fce7f3;
    }

    .tool-icon.drawings {
        background: #e0e7ff;
    }

    .tool-icon.specs {
        background: #ccfbf1;
    }

    .status-active .e-chip {
        background: #d1fae5;
        color: #065f46;
        font-size: 0.75rem;
    }

    .status-development .e-chip {
        background: #fef3c7;
        color: #92400e;
        font-size: 0.75rem;
    }

    .tool-card h3 {
        margin: 0 0 0.5rem 0;
        font-size: 1.125rem;
        font-weight: 600;
        color: #1e293b;
    }

    .tool-card p {
        margin: 0 0 1rem 0;
        color: #64748b;
        font-size: 0.875rem;
        line-height: 1.5;
    }

    .tool-features {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .feature-tag {
        background: white;
        border: 1px solid #e2e8f0;
        padding: 0.25rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        color: #475569;
    }

    .tool-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 1rem;
        border-top: 1px solid #e2e8f0;
    }

    .tool-type {
        font-size: 0.875rem;
        color: #64748b;
    }

    .activity-section {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.06);
    }

    .activity-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .activity-item {
        display: flex;
        gap: 1rem;
        padding: 1rem;
        background: #f9fafb;
        border-radius: 8px;
    }

    .activity-icon {
        width: 40px;
        height: 40px;
        background: #e0e7ff;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #4f46e5;
    }

    .activity-content {
        flex: 1;
    }

    .activity-description {
        margin: 0 0 0.25rem 0;
        color: #1e293b;
        font-size: 0.875rem;
    }

    .activity-time {
        color: #6b7280;
        font-size: 0.75rem;
    }

    .no-activity {
        text-align: center;
        padding: 2rem;
        color: #9ca3af;
    }

    @media (max-width: 768px) {
        .header-content {
            flex-direction: column;
            align-items: flex-start;
        }

        .tools-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

@code {
    private string? CurrentProjectId;
    private List<EngineeringActivity> RecentActivities = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadRecentActivity();
    }

    private async Task LoadRecentActivity()
    {
        // This would load from your storage service
        // For now, using sample data
        RecentActivities = new List<EngineeringActivity>
        {
            new EngineeringActivity
            {
                Type = "calculation",
                Description = "Beam design calculation completed for Project A",
                Timestamp = DateTime.Now.AddHours(-2)
            },
            new EngineeringActivity
            {
                Type = "model",
                Description = "3D model viewed: Building B - Level 3",
                Timestamp = DateTime.Now.AddDays(-1)
            },
            new EngineeringActivity
            {
                Type = "export",
                Description = "Design summary exported for Project C",
                Timestamp = DateTime.Now.AddDays(-3)
            }
        };
    }

    private void NavigateToTool(string path)
    {
        Navigation.NavigateTo(path);
    }

    private string GetActivityIcon(string type)
    {
        return type switch
        {
            "calculation" => "e-icons e-calculator",
            "model" => "e-icons e-3d-model",
            "export" => "e-icons e-export",
            _ => "e-icons e-file"
        };
    }

    private string GetRelativeTime(DateTime timestamp)
    {
        var timeSpan = DateTime.Now - timestamp;
        
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes} minutes ago";
        if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours} hours ago";
        if (timeSpan.TotalDays < 7)
            return $"{(int)timeSpan.TotalDays} days ago";
        
        return timestamp.ToString("MMM dd, yyyy");
    }

    private class EngineeringActivity
    {
        public string Type { get; set; } = "";
        public string Description { get; set; } = "";
        public DateTime Timestamp { get; set; }
    }
}
